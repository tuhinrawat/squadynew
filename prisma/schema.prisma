// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  BIDDER
}

enum AuctionStatus {
  DRAFT
  LIVE
  MOCK_RUN
  PAUSED
  COMPLETED
  MOCK_RUN
}

enum FieldType {
  TEXT
  NUMBER
  EMAIL
  PHONE
  DATE
  SELECT
  MULTISELECT
  CHECKBOX
  TEXTAREA
  URL
}

enum PlayerStatus {
  AVAILABLE
  SOLD
  UNSOLD
  RETIRED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      Role     @default(ADMIN)
  createdAt DateTime @default(now())

  // Relations
  auctions      Auction[]
  bidderProfile Bidder?

  @@map("users")
}

model Auction {
  id               String        @id @default(cuid())
  name             String
  slug             String?       @unique // URL-friendly slug for the auction
  description      String?
  image            String?       // Auction cover image URL
  rules            Json
  status           AuctionStatus @default(DRAFT)
  isPublished      Boolean       @default(false)
  customFields           Json? // Store custom field definitions for public registration
  columnOrder            Json? // Store Excel column order as array
  visibleColumns         Json? // Store visible columns for player table
  analyticsVisibleColumns Json? // Store visible columns for analytics player table (separate from main table)
  registrationOpen       Boolean       @default(true)
  createdById      String
  currentPlayerId  String?
  bidHistory       Json?
  createdAt        DateTime      @default(now())

  // Analytics fields
  totalViews       Int           @default(0) // Total page views
  uniqueVisitors   Int           @default(0) // Unique visitors count
  peakViewers      Int           @default(0) // Peak concurrent viewers
  timerViews       Int           @default(0) // Countdown timer page views

  // Scheduled start date/time for the auction
  scheduledStartDate DateTime?   // When the auction is scheduled to start

  // Relations
  createdBy    User          @relation(fields: [createdById], references: [id])
  players      Player[]
  bidders      Bidder[]
  chatMessages ChatMessage[]
  views        AuctionView[] // Individual view records
  fixtures     Fixture[]     // Fixtures/matches for this auction

  // Performance indexes
  @@index([createdById])
  @@index([status])
  @@index([isPublished])
  @@index([createdById, status])
  @@index([slug])
  @@map("auctions")
}

model Player {
  id        String       @id @default(cuid())
  auctionId String
  data      Json
  status    PlayerStatus @default(AVAILABLE)
  isIcon    Boolean      @default(false)
  soldTo    String?
  soldPrice Float?
  createdAt DateTime     @default(now())

  // Relations
  auction Auction @relation(fields: [auctionId], references: [id])

  // Performance indexes
  @@index([auctionId])
  @@index([auctionId, status])
  @@index([auctionId, status, soldPrice])
  @@map("players")
}

model Bidder {
  id             String   @id @default(cuid())
  userId         String   @unique
  auctionId      String
  teamName       String?
  username       String
  purseAmount    Float
  remainingPurse Float
  logoUrl        String?
  createdAt      DateTime @default(now())

  // Relations
  user            User      @relation(fields: [userId], references: [id])
  auction         Auction   @relation(fields: [auctionId], references: [id])
  fixturesAsTeam1 Fixture[] @relation("Team1Fixtures")
  fixturesAsTeam2 Fixture[] @relation("Team2Fixtures")

  @@unique([auctionId, username])
  // Performance indexes
  @@index([auctionId])
  @@index([userId])
  @@index([auctionId, userId])
  @@map("bidders")
}

model Invitation {
  id        String    @id @default(cuid())
  code      String    @unique
  used      Boolean   @default(false)
  usedBy    String?
  usedAt    DateTime?
  createdBy String
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@map("invitations")
}

model ChatMessage {
  id        String   @id @default(cuid())
  auctionId String
  username  String
  userId    String?  // Optional unique identifier for anonymous users
  message   String   @db.Text
  createdAt DateTime @default(now())

  // Relations
  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([auctionId, createdAt])
  @@map("chat_messages")
}

model AuctionView {
  id          String   @id @default(cuid())
  auctionId   String
  visitorId   String   // Anonymous visitor identifier (from cookie/session)
  userAgent   String?  // Browser user agent
  ipAddress   String?  // IP address (hashed for privacy)
  referrer    String?  // Where they came from
  viewedAt    DateTime @default(now())

  // Relations
  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([auctionId])
  @@index([auctionId, visitorId])
  @@index([auctionId, viewedAt])
  @@map("auction_views")
}

model Fixture {
  id          String    @id @default(cuid())
  auctionId   String
  matchName   String    // Name of the match/fixture
  team1Id     String    // Bidder 1
  team2Id     String    // Bidder 2
  matchDate   DateTime? // Optional scheduled date
  venue       String?   // Optional venue
  status      String    @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  result      String?   // Match result (optional)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  team1   Bidder  @relation("Team1Fixtures", fields: [team1Id], references: [id])
  team2   Bidder  @relation("Team2Fixtures", fields: [team2Id], references: [id])

  // Performance indexes
  @@index([auctionId])
  @@index([team1Id])
  @@index([team2Id])
  @@map("fixtures")
}
